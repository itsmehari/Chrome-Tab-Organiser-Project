"use strict";let chartInstance=null;function showToast(e){const t=document.getElementById("toast");t&&(t.textContent=e,t.classList.add("show"),setTimeout(()=>{t.classList.remove("show")},3e3))}function handleAction(e,t={},n=null){const a=document.getElementById("spinner");a&&(a.style.display="inline-block"),chrome.runtime.sendMessage({action:e,...t},t=>{if(a&&(a.style.display="none"),chrome.runtime.lastError)return console.error(`Error with action ${e}:`,chrome.runtime.lastError),void showToast("An error occurred.");"error"===t.status?showToast(t.message||"An unknown error occurred."):t.message&&showToast(t.message),"organizeAll"===e&&t.scatteredTabs&&t.scatteredTabs.length>0&&confirm(`Organized main domains. Do you want to group the remaining ${t.scatteredTabs.length} scattered tabs?`)&&handleAction("groupScatteredTabs",{tabIds:t.scatteredTabs}),fetchAndDisplayStats(),fetchAndDisplayDomains(),n&&n(t)})}function fetchAndDisplayStats(){const e=document.getElementById("stats-loader"),t=document.getElementById("stats-container-grid");e&&t&&(e.style.display="block",t.innerHTML="",chrome.runtime.sendMessage({action:"getComprehensiveStats"},n=>{if(e.style.display="none",n&&"success"===n.status){[{label:"Total Tabs",value:n.totalTabs},{label:"Windows",value:n.totalWindows},{label:"Tab Groups",value:n.totalGroups},{label:"Audible Tabs",value:n.audibleTabs,id:"audible-tabs-link"},{label:"Duplicate Tabs",value:n.duplicateTabs},{label:"Memory Savers",value:n.discardedTabs}].forEach(e=>{const n=document.createElement("div");n.className="stat-item",n.innerHTML=`\n          <div class="stat-value" ${e.id?`id="${e.id}"`:""}>${e.value}</div>\n          <div class="stat-label">${e.label}</div>\n        `,t.appendChild(n)})}}))}function displayDomainList(e){const t=document.getElementById("domain-list"),n=document.getElementById("empty-domain-list");t&&n&&(t.innerHTML="",0!==e.length?(n.style.display="none",e.forEach(({domain:e,tabCount:n,favicon:a})=>{const s=document.createElement("div");s.className="tab-preview",s.innerHTML=`\n      <img src="${a||"icons/icon16.jpeg"}" class="tab-thumb" alt="Favicon for ${e}">\n      <div class="tab-info">\n        <div class="tab-title">${e}</div>\n      </div>\n      <span class="badge">${n}</span>\n      <div class="domain-actions">\n        <button class="btn btn-sm btn-success save-domain-btn" data-domain="${e}">Save</button>\n        <button class="btn btn-sm organize-domain-btn" data-domain="${e}">Organize</button>\n        <button class="btn btn-sm btn-danger close-domain-btn" data-domain="${e}">Close All</button>\n        <button class="btn btn-sm btn-secondary copy-domain-btn" data-domain="${e}" title="Copy URLs">Copy</button>\n      </div>\n    `,t.appendChild(s)})):n.style.display="block")}function renderTopDomainsChart(e){const t=document.getElementById("chart-loader"),n=document.getElementById("domain-chart").getContext("2d");if(!t||!n)return;t.style.display="none";const a=e.slice(0,5),s=a.map(e=>e.domain),o=a.map(e=>e.tabCount);chartInstance&&chartInstance.destroy(),chartInstance=new Chart(n,{type:"pie",data:{labels:s,datasets:[{data:o,backgroundColor:["#ff6384","#36a2eb","#cc65fe","#ffce56","#4bc0c0"],borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,legend:{position:"bottom",labels:{fontColor:"dark"===document.documentElement.getAttribute("data-theme")?"#fff":"#333"}}}})}function initializeTheme(){const e=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",e);const t=document.getElementById("dark-toggle");t&&(t.textContent="dark"===e?"☀️":"🌙")}function toggleTheme(){const e="dark"===document.documentElement.getAttribute("data-theme")?"light":"dark";localStorage.setItem("theme",e),initializeTheme(),fetchAndDisplayDomains()}function fetchAndDisplaySavedGroups(){chrome.runtime.sendMessage({action:"getSavedGroups"},e=>{if(chrome.runtime.lastError)return console.error(chrome.runtime.lastError),void showToast("Error fetching saved groups.");const t=document.getElementById("saved-groups-list"),n=document.getElementById("empty-saved-list");t&&n&&(t.innerHTML="",e.groups&&0!==e.groups.length?(n.style.display="none",e.groups.forEach(e=>{const n=document.createElement("div");n.className="tab-preview";const a=new Date(e.timestamp).toLocaleString();n.innerHTML=`\n        <img src="${e.favicon||"icons/icon16.jpeg"}" class="tab-thumb" alt="Favicon for saved group">\n        <div class="tab-title">${e.name} <span class="badge">${e.urls.length}</span><br><small>${a}</small></div>\n        <div class="domain-actions">\n          <button class="btn btn-sm restore-group-btn" data-timestamp="${e.timestamp}">Restore</button>\n          <button class="btn btn-sm btn-danger delete-group-btn" data-timestamp="${e.timestamp}">Delete</button>\n        </div>\n      `,t.appendChild(n)})):n.style.display="block")})}function fetchAndDisplayDomains(){const e=document.getElementById("spinner");e&&(e.style.display="inline-block"),chrome.runtime.sendMessage({action:"getDomainAnalysis"},t=>{e&&(e.style.display="none"),t&&"success"===t.status&&(displayDomainList(t.domains),renderTopDomainsChart(t.domains))})}document.addEventListener("DOMContentLoaded",()=>{initializeTheme(),fetchAndDisplayStats(),fetchAndDisplayDomains();const e=document.getElementById("main-content"),t=document.getElementById("saved-groups-content"),n=document.getElementById("show-analyzer-btn"),a=document.getElementById("show-saved-btn"),s=document.getElementById("organize-all-btn"),o=document.getElementById("close-duplicates-btn"),i=document.getElementById("undo-btn"),d=document.getElementById("redo-btn"),l=document.getElementById("suggest-groups-btn");document.getElementById("dark-toggle").addEventListener("click",toggleTheme);const c=document.getElementById("settings-link");c&&c.addEventListener("click",()=>chrome.runtime.openOptionsPage()),s&&s.addEventListener("click",()=>handleAction("organizeAll")),o&&o.addEventListener("click",()=>handleAction("closeDuplicates")),i&&i.addEventListener("click",()=>handleAction("undo")),d&&d.addEventListener("click",()=>handleAction("redo")),document.body.addEventListener("click",e=>{const t=e.target;if(t.closest(".organize-domain-btn")){handleAction("organizeByDomain",{domain:t.closest(".organize-domain-btn").dataset.domain})}else if(t.closest(".close-domain-btn")){handleAction("closeTabsByDomain",{domain:t.closest(".close-domain-btn").dataset.domain})}else if(t.closest(".copy-domain-btn")){handleAction("copyUrlsByDomain",{domain:t.closest(".copy-domain-btn").dataset.domain})}else if(t.closest(".save-domain-btn")){handleAction("saveTabsForLater",{domain:t.closest(".save-domain-btn").dataset.domain})}else if(t.closest(".restore-group-btn")){handleAction("restoreSavedGroup",{timestamp:t.closest(".restore-group-btn").dataset.timestamp},fetchAndDisplaySavedGroups)}else if(t.closest(".delete-group-btn")){handleAction("deleteSavedGroup",{timestamp:t.closest(".delete-group-btn").dataset.timestamp},fetchAndDisplaySavedGroups)}else"audible-tabs-link"===t.id&&(e.preventDefault(),handleAction("focusAudibleTab"))}),n.addEventListener("click",()=>{e.style.display="block",t&&(t.style.display="none"),n.classList.add("active"),a.classList.remove("active")}),a.addEventListener("click",()=>{e.style.display="none",t&&(t.style.display="block"),n.classList.remove("active"),a.classList.add("active"),fetchAndDisplaySavedGroups()}),l.addEventListener("click",()=>handleAction("suggestByContent")),document.getElementById("stats-container-grid").addEventListener("click",e=>{"audible-tabs-link"===e.target.id&&handleAction("focusAudibleTab")})});